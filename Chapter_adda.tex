\chapter{\textsc{AD et DA}}

Les Convertisseurs Analogique-Numérique (ADC pour \it Analog to Digital Converter \rm) et Numérique-Analogique (DAC pour \it Digital to Analog Converter \rm) sont des éléments importants de toute chaîne d'acquisition de donnée.\\
En effet, les opérations complexes de traitement de signal sont aujourd'hui exécutées par des circuits numériques, dont les microcontrôleurs font partie. Pour être traités par un microcontrôleur, les signaux analogiques doivent donc être convertis en nombres.\\
La figure \ref{fig:Acq_Chain} illustre une chaîne typique d'acquisition de donnée.

\begin{figure}[htb]
  \centering
  \includegraphics [angle=0, width=14cm]{./Figures/Chap11_ADC/Acq_Chain.pdf}
  \rule{35em}{0.5pt}
  \caption{Chaîne d'acquisition et traitement de signal}
  \label{fig:Acq_Chain}
\end{figure}

\section{Convertisseur AD}
L'ADC est un circuit dont la fonction est de convertir une grandeur physique $V_{in}$ - en général une tension, parfois un courant - en un nombre N représenté sur plusieurs bits, "proportionnel" à cette grandeur physique.
Le terme proportionnel est abusif dans la mesure où la fonction de transfert $N = f(V_{in})$ est une fonction en escalier, comme illustré à la figure \ref{fig:ADC_Fonction}.

\begin{figure}[htb]
  \centering
  \includegraphics [angle=0, width=10cm]{./Figures/Chap11_ADC/ADC_Fonction.pdf}
  \rule{35em}{0.5pt}
  \caption{Fonction de transfert d'un ADC idéal 4-bits}
  \label{fig:ADC_Fonction}
\end{figure}

Les caractéristiques importantes de cette fonction de transfert sont:
\begin{itemize}[label=\textbullet,font=\small]
\item l'intervalle des tensions d'entrée $[V_{in\_min}, V_{in\_max}$]
\item la résolution, égale à $log_{2}(N_{max})$
\item les imperfections qui l'entachent, et qui sont:
\begin{itemize}[label=\textbullet,font=\small]
\item offset
\item erreur de gain
\item "non linéarité" de la fonction
\end{itemize}
\end{itemize}

Il existe plusieurs méthodes pour convertir une grandeur physique en un nombre. Elles se différencient principalement par la résolution atteignable et la rapidité du processus de conversion, et aussi par leur complexité.\\
Dans les microcontrôleurs, le convertisseur AD le plus souvent rencontré est le convertisseur à approximations successives, dont l'avantage est d'offrir un bon compromis entre résolution et rapidité, pour une consommation de courant très faible.

\section{Convertisseur à approximations successives}

Ce type de convertisseur utilise un processus de dichotomie pour traduire progressivement une tension analogique en un nombre. Le temps de conversion est fonction du nombre de bits souhaités.\\
Le principe est illustré à la figure \ref{fig:ADC_SAR_Diagram}.

\begin{figure}[htb]
  \centering
  \includegraphics [angle=0, width=10cm]{./Figures/Chap11_ADC/SA_ADC_block_diagram.png}
  \rule{35em}{0.5pt}
  \caption{Principe du convertisseur à approximations successives}
  \label{fig:ADC_SAR_Diagram}
\end{figure}

Un séquenceur (généralement nommé SAR pour \it Successive Approximation Register\rm), couplé à un convertisseur Digital-Analogique (DAC) génère une tension analogique, qui est comparée au signal à convertir.
Le résultat de cette comparaison est alors introduit dans le SAR, qui va le prendre en compte, pour la suite du processus de dichotomie, jusqu'à complétion. La figure \ref{fig:ADC_SAR} illustre la chronologie du processus de conversion, dans le cas d'un ADC 4-bits.\\
Dans cet exemple, le DAC est capable de générer 16 tensions notées $x.FS$ (FS signifie \it Full Scale\rm), avec $0 \leqslant x \leqslant 15$. Les valeurs minimale et maximale de ces tensions sont appelées \it tensions de référence\rm.\\
Le test du MSB détermine si $V_{in}$ est supérieur ou inférieur à $\scriptstyle {}^1\!/\!_2.FS$. Dans l'exemple, dès lors que $V_{in} \leqslant \scriptstyle {}^1\!/\!_2.FS$, le MSB vaut 1. Pour tester le bit de poids inférieur (MSB-1), le séquenceur commande le DAC pour qu'il génère $\scriptstyle {}^3\!/\!_4.FS$. Cette fois,  $V_{in} \geqslant \scriptstyle {}^3\!/\!_4.FS$, donc (MSB-1) = 0; ceci signifie qu'il ne fallait pas ajouter $\scriptstyle {}^1\!/\!_4.FS$ à 
$\scriptstyle {}^1\!/\!_2.FS$ mais $\scriptstyle {}^1\!/\!_8.FS$.\\
Le processus continue ainsi jusqu'à l'obtention du LSB, au rythme d'un bit par étape.

\begin{figure}[htb]
  \centering
  \includegraphics [angle=0, width=13cm]{./Figures/Chap11_ADC/ADC_SAR.pdf}
  \rule{35em}{0.5pt}
  \caption{Etapes de conversion d'un ADC 4-bits à approximations successives}
  \label{fig:ADC_SAR}
\end{figure}

Le convertisseur réalise donc sa conversion en positionnant en premier le bit de poids fort (MSB) et en descendant progressivement jusqu'au LSB.
Ces convertisseurs ont des résolutions d'une douzaine de bits environ, mais peuvent atteindre 16 bits au moyen de technologies spéciales.\\

Il est important de noter que la tension d'entrée doit être mémorisée pendant toute la durée du processus de conversion. Ceci est effectué au moyen d'un circuit auxiliaire appelé "Echantillonneur-Bloqueur" (\it Sample and Hold\rm). Le terme "Echantillonneur" fait référence à l'instant auquel la tension est saisie; "Bloqueur" fait référence à sa mémorisation. 

Le convertisseur DAC peut être construit au moyen de:
\begin{itemize}[label=\textbullet,font=\small]
\item un diviseur de tension résistif couplé à des interrupteurs
\item un diviseur de courant de type R-2R
\item un diviseur de tension à capacités pondérées
\end{itemize}
Le détail de ces circuits sort du cadre de ce cours.

\section{Cas du MSP430}
Les microcontrôleurs MSP430 peuvent contenir plusieurs types de convertisseurs AD:
\begin{itemize}[label=\textbullet,font=\small]
\item AD 10-bits à approximations successives
\item AD 12-bits à approximations successives
\item AD 16-bits Sigma-Delta
\end{itemize}

\subsection{Cas du MSP430F5529}
Ce microcontrôleur contient un convertisseur AD 12 bits à approximations successives avec les caractéristiques suivantes.
\begin{itemize}[label=\textbullet,font=\small]
\item Plus de 200 kSPS : 200'000 échantillons par seconde
\item Echantillonneur-Bloqueur avec période programmable, contrôlée par logiciel ou par timers
\item Lancement des conversions par logiciel ou par timers
\item Référence de tension interne sélectionnable par logiciel (1.5 V, 2.0 V, ou 2.5 V)
\item Référence interne ou externe
\item Jusqu'à 12 canaux d?entrée configurables individuellement
\item Canaux d'entrée pour capteur de température interne, AVCC, et références externes
\item Registres de stockage de 16 résultats de conversion
\end{itemize}

\subsection{Schéma de l'ADC 12-bits}
La figure \ref{fig:ADC_Schema} représente le schéma complet du périphérique ADC12, l'ADC 12-bits présent dans le MSP430F5529. 

\begin{figure}[H]
  \centering
  \includegraphics [angle=0, width=16cm]{./Figures/Chap11_ADC/ADC_Schema.pdf}
  \rule{35em}{0.5pt}
  \caption{Schéma du convertisseur ADC12 dans le MSP430F5529}
  \label{fig:ADC_Schema}
\end{figure}

On y trouve:
\begin{itemize}[label=\textbullet,font=\small]
\item le coeur de l'ADC, avec l'échantillonneur-bloqueur, au centre
\item le bloc de sélection des références de tension
\item le bloc de sélection de l'horloge de conversion, qui définit le rythme auquel les bits du résultat sont obtenus
\item le bloc de lancement d'une conversion. Il est possible de lancer automatiquement des conversions
\item une mémoire pouvant contenir les résultats de 16 conversions
\item à gauche, le circuit de sélection du signal à convertir
\end{itemize}

Comme on l'a déjà vu avec d'autres périphériques, les réglages du convertisseur ADC12 se font par le logiciel, en positionnant les champs logiques apparaissant sur le schéma, qui sont accessibles dans des registres de contrôle.

\pagebreak
\subsection{Echantillonnage et conversion}
Le processus de conversion commence par l'échantillonnage du signal d'entrée, puis continue avec la conversion par approximations successives. Le processus est lancé sur le flanc montant du signal SHI, comme indiqué à la figure \ref{fig:ADC12SHP0}.

\begin{figure}[H]
  \centering
  \includegraphics [angle=0, width=14cm]{./Figures/Chap11_ADC/ADC12SHP0.pdf}
  \rule{35em}{0.5pt}
  \caption{Chronogramme du processus d'échantillonnage et conversion (ADC12SHP = 0)}
  \label{fig:ADC12SHP0}
\end{figure}

Le signal SAMPCON (\it Sampling Control\rm) joue un rôle particulier car son flanc montant détermine le début de la saisie du signal d'entrée, qui dure tant que $SAMPCON = 1$. La conversion à proprement parler démarre au flanc descendant de  SAMPCON et dure 13 périodes du signal ADC12CLK pour une conversion sur 12 bits.
La durée du signal SAMPCON doit être réglable pour pouvoir ajuster le temps d'échantillonnage à la résistance interne de la source d'où provient $V_{in}$. En effet, l'entrée de l'échantillonneur-bloqueur (le \it Sample and Hold\rm) est une capacité; sa charge est soumise à une constante de temps qui dépend de la résistance de la source.\\

\subsection{Sélection de l'horloge de conversion}
L'horloge de conversion ADC12CLK rythme le processus de conversion par approximations successives. Elle détermine donc le temps alloué au calcul de chaque bit, du MSB au LSB.\\

Lorsque l'utilisateur souhaite se simplifier la vie (ADC12SHP = 0), elle détermine aussi la durée de l'échantillonnage, via un timer interne à l'ADC. Ce timer, noté \it Sample Timer\rm  sur la figure \ref{fig:ADC_Schema} peut générer une durée d'échantillonnage comprise entre 4 et 1024 cycles du signal ADC12CLK.

\subsection{Lancement d'une conversion}
Plusieurs méthodes sont envisageables:
\begin{itemize}[label=\textbullet,font=\small]
\item lancement par logiciel, en activant le bit ADC12SC (\it Start Conversion\rm)
\item lancement automatique par un timer
\end{itemize}

\subsection{Sélection des références de tension}
Les références de tension déterminent l'intervalle dans lequel la tension à convertir doit se trouver. La borne inférieure peut être égale à GND, mais pas nécessairement. Par contre, la borne supérieure est toujours inférieure à la tension d'alimentation VCC. La raison est que les circuits internes au convertisseur ont besoin d'une marge entre $V_{REF_Sup}$ et VCC pour pouvoir fonctionner correctement.


Mode d'échantillonnage «étendu» (ADC12SHP = 0, SHI est «étendu»)
SHI contrôle directement SAMPCON, qui définit la durée d'échantillonnage
Le flanc descendant du signal SAMPCON déclenche le processus de conversion avec ADC12CLK

Mode d'échantillonnage «pulse» (ADC12SHP = 1)
SHI déclenche le signal SAMPCON
La durée d?échantillonnage tsample est contrôlée par les bits ADC12SHT0x et ADC12SHT1x dans ADC12CTL0

\subsection{Stockage des résultats}
Lorsqu'une conversion est terminée, l'ADC peut émettre une requête d'interruption. Toutefois, dans de nombreuses applications, il est nécessaire de convertir plusieurs tensions différentes. Les raisons peuvent être:
\begin{itemize}[label=\textbullet,font=\small]
\item les signaux générés par plusieurs capteurs, et connectées sur l'ADC via ses différentes entrées (A0 à A15) doivent être convertis en nombres;
\item plusieurs valeurs successives d'une même tension doivent être converties, pour pouvoir calculer une moyenne ou y appliquer une fonction de filtrage numérique;
\item on ne souhaite pas surcharger le CPU avec des interruptions trop fréquentes;
etc...
\end{itemize}

Pour résoudre ce genre de situation, l'ADC dispose d'une mémoire pouvant contenir jusqu'à 16 résultats de conversion.




Cas du MSP4340F5529 : Stockage
ADC12CSTARTADDx définit le début de la séquence de conversions , c'est-à-dire le registre dans lequel est stocké le premier résultat de conversion, ainsi que le registre qui le contrôle (ADC12MCTLa)

Dans ADC12MCTLb, le bit ADC12EOS (End Of Sequence) définit le registre dans lequel est stocké le dernier résultat de conversion

Une séquence de conversion concerne une liste de canaux d'entrée

A la fin de la séquence, une interruption est générée, et il faut déclencher une nouvelle séquence

Il est possible d'enchaîner automatiquement les séquences, en settant le bit ADC12MSC (Multiple Sequence of Conversion)
 


CONSEQx	Mode	Fonctionnement
0	Un seul canal	Une conversion unique du canal sélectionné par les bits ADC12INCHx du registre ADC12MCTLz. Le résultat est stocké dans ADC12MEMz
	Conversion unique	
1	Séquence de	Une conversion unique des canaux sélectionnés par les bits ADC12INCHx des registres ADC12MCTLa-b. Le résultat est stocké dans ADC12MEMa à ADC12MEMb. Le bit ADC12EOS doit être à ?1? dans ADC12MEMb.
	n canaux	
	Conversion unique	
10	Un seul canal	Un canal est converti plusieurs fois. Il est sélectionné par les bits ADC12INCHx du registre ADC12MCTLz. Le résultat est stocké dans un seul registre ADC12MEMz. Il faut récupérer les résultats successifs au fur et à mesure qu?ils sont produits.
	Conversion répétitive	
11	Séquence de	Similaire au mode 01, mais la séquence peut être répétée avec un nouveau signal de déclenchement
	n canaux	
	Conversion ré pétitive	


Interruptions
Une interruption est générée à la fin de chaque séquence de conversions (qu?elle soit de longueur 1 ou  plus)
Trois registres de contrôle:
ADC12IFG : Flags d'interruption. Le flag activé est celui qui correspond à la dernière conversion de la séquence
ADC12IE : autorisation des interruptions pour chaque registre de ontrôle de conversion
ADC12IV : contient le «vecteur d?interruption, qui doit être testé au moyen d?une instruction de type switch...case





\section{AD}


\subsection{ploutch}






